<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yossarian Go - Log Sanitization</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
    <style>
        /* Material Design CSS - Air-gap ready */
        :root {
            --md-primary: #1976d2;
            --md-primary-dark: #1565c0;
            --md-primary-light: #42a5f5;
            --md-secondary: #dc004e;
            --md-surface: #ffffff;
            --md-surface-variant: #f5f5f5;
            --md-on-surface: #1c1b1f;
            --md-on-surface-variant: #49454f;
            --md-outline: #79747e;
            --md-success: #2e7d32;
            --md-warning: #f57c00;
            --md-error: #d32f2f;
            --md-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --md-shadow-elevated: 0 4px 8px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--md-surface-variant);
            color: var(--md-on-surface);
            line-height: 1.5;
        }

        /* App Bar */
        .app-bar {
            background: var(--md-primary);
            color: white;
            padding: 16px 24px;
            box-shadow: var(--md-shadow-elevated);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-bar h1 {
            font-size: 20px;
            font-weight: 500;
            margin: 0;
        }

        .app-bar .subtitle {
            font-size: 14px;
            opacity: 0.87;
            margin-top: 4px;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            gap: 16px;
            margin-top: 12px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Material Cards */
        .card {
            background: var(--md-surface);
            border-radius: 12px;
            box-shadow: var(--md-shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
            color: var(--md-on-surface);
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--md-on-surface-variant);
            margin-top: 4px;
        }

        .card-content {
            padding: 24px;
        }

        /* User Info Banner */
        .user-banner {
            background: linear-gradient(135deg, var(--md-primary-light), var(--md-primary));
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .user-banner .welcome {
            font-size: 16px;
            font-weight: 500;
        }

        .user-banner .auth-info {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Sensitive Words Section */
        .words-section {
            display: grid;
            gap: 16px;
        }

        .textarea-field {
            position: relative;
        }

        .textarea-field label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--md-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .textarea-field textarea {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            border: 2px solid var(--md-outline);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .textarea-field textarea:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--md-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--md-primary-dark);
            box-shadow: var(--md-shadow-elevated);
        }

        .btn-secondary {
            background: transparent;
            color: var(--md-primary);
            border: 2px solid var(--md-primary);
        }

        .btn-secondary:hover {
            background: var(--md-primary);
            color: white;
        }

        .btn-success {
            background: var(--md-success);
            color: white;
        }

        .btn-warning {
            background: var(--md-warning);
            color: white;
        }

        /* File Upload Zone */
        .upload-zone {
            border: 2px dashed var(--md-outline);
            border-radius: 12px;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.3s;
            background: var(--md-surface-variant);
            cursor: pointer;
            position: relative;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--md-primary);
            background: rgba(25, 118, 210, 0.05);
        }

        .upload-zone.processing {
            pointer-events: none;
            opacity: 0.7;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--md-primary);
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }

        .file-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* File List */
        .file-list {
            margin-top: 16px;
            display: none;
        }

        .file-list.visible {
            display: block;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-grow: 1;
        }

        .file-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--md-primary);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .file-details {
            flex-grow: 1;
        }

        .file-name {
            font-weight: 500;
            font-size: 14px;
        }

        .file-size {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .file-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .file-status.ready {
            background: #e8f5e8;
            color: var(--md-success);
        }

        .file-status.processing {
            background: #fff3e0;
            color: var(--md-warning);
        }

        .file-status.error {
            background: #ffebee;
            color: var(--md-error);
        }

        .file-status.complete {
            background: #e8f5e8;
            color: var(--md-success);
        }

        /* Progress Bars */
        .progress-container {
            margin-top: 24px;
            display: none;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 500;
            font-size: 14px;
        }

        .progress-stats {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--md-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Details/Summary styling */
        details summary::-webkit-details-marker {
            display: none;
        }
        
        details[open] #wordsToggleIcon {
            transform: rotate(90deg);
        }
        
        details summary:hover {
            background: var(--md-surface-variant);
        }

        .progress-text {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            text-align: center;
        }

        /* Results Section */
        .results-section {
            margin-top: 24px;
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--md-primary);
            box-shadow: var(--md-shadow);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-primary);
        }

        .metric-label {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* File Results */
        .file-results {
            background: white;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--md-shadow);
        }

        .file-result-header {
            background: var(--md-surface-variant);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-result-name {
            font-weight: 500;
            font-size: 14px;
        }

        .file-result-time {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .file-result-content {
            padding: 20px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--md-surface-variant);
            border-radius: 6px;
        }

        .category-name {
            font-size: 13px;
            color: var(--md-on-surface-variant);
        }

        .category-count {
            font-weight: 500;
            color: var(--md-primary);
        }

        /* Download Section */
        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .download-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--md-shadow);
            text-align: center;
        }

        .download-icon {
            font-size: 32px;
            color: var(--md-primary);
            margin-bottom: 12px;
        }

        .download-title {
            font-weight: 500;
            margin-bottom: 8px;
        }

        .download-description {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            margin-bottom: 16px;
        }

        /* Status Message */
        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 14px;
            display: none;
        }

        .status-message.visible {
            display: block;
        }

        .status-message.success {
            background: #e8f5e8;
            color: var(--md-success);
            border-left: 4px solid var(--md-success);
        }

        .status-message.error {
            background: #ffebee;
            color: var(--md-error);
            border-left: 4px solid var(--md-error);
        }

        .status-message.info {
            background: #e3f2fd;
            color: var(--md-primary);
            border-left: 4px solid var(--md-primary);
        }

        
        /* Getting Started Section */
        .getting-started {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid var(--md-primary);
        }

        .getting-started details {
            cursor: pointer;
        }

        .getting-started summary {
            padding: 20px 24px;
            font-size: 18px;
            font-weight: 500;
            color: var(--md-primary);
            list-style: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .getting-started summary::-webkit-details-marker {
            display: none;
        }

        .getting-started summary::before {
            content: 'â–¼';
            font-size: 14px;
            transition: transform 0.3s;
        }

        .getting-started details[open] summary::before {
            transform: rotate(-180deg);
        }

        .getting-started-content {
            padding: 0 24px 24px;
        }

        .help-section {
            margin-bottom: 32px;
        }

        .help-section h3 {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section p {
            font-size: 14px;
            line-height: 1.6;
            color: var(--md-on-surface-variant);
            margin-bottom: 12px;
        }

        .example-box {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            border-left: 3px solid var(--md-primary);
        }

        .example-item {
            margin-bottom: 16px;
        }

        .example-item:last-child {
            margin-bottom: 0;
        }

        .example-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--md-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .example-text {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 4px;
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
            word-break: break-all;
        }

        .example-text.before {
            background: #ffebee;
            color: #c62828;
        }

        .example-text.after {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }

        .step-list li {
            counter-increment: step-counter;
            margin-bottom: 20px;
            padding-left: 50px;
            position: relative;
        }

        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 36px;
            height: 36px;
            background: var(--md-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .step-list li strong {
            display: block;
            font-size: 15px;
            color: var(--md-on-surface);
            margin-bottom: 4px;
        }

        .step-list li p {
            margin: 0;
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }

        .tip-box {
            background: #fff3e0;
            border-left: 4px solid var(--md-warning);
            padding: 12px 16px;
            border-radius: 4px;
            margin-top: 16px;
        }

        .tip-box strong {
            color: var(--md-warning);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            /* Stack Hebrew box on mobile */
            .card-content[style*="justify-content: space-between"] {
                flex-direction: column !important;
                gap: 16px !important;
                text-align: center !important;
            }
            
            .card-content[style*="justify-content: space-between"] > div {
                text-align: center !important;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }

            .nav-links {
                flex-wrap: wrap;
            }

            .results-summary {
                grid-template-columns: 1fr;
            }

            .download-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- App Bar -->
    <header class="app-bar">
        <h1>ğŸ›¡ï¸ Yossarian Go</h1>
        <div class="subtitle">Automatically remove sensitive information from log files <span id="version" style="opacity: 0.7; font-size: 12px;"></span></div>
        <nav class="nav-links">
            <span id="username" style="color: white; margin-right: 15px;"></span>
            <a href="/health">ğŸ“Š Health Check</a>
            <a href="/admin">âš™ï¸ Admin Panel</a>
            <a href="/admin/logout" id="logoutLink" style="display: none;">ğŸšª Logout</a>
        </nav>
    </header>

    <div class="container">
        <!-- User Info Banner (Dynamic) -->
        <div class="user-banner" id="userBanner" style="display: none;">
            <div class="welcome">ğŸ‘¤ Welcome back, <span id="userName">User</span>!</div>
            <div class="auth-info">ğŸ” Authenticated via Enterprise SSO</div>
        </div>

                <!-- Hebrew Documentation Link -->
        <div class="card" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-left: 4px solid #4caf50;">
            <div class="card-content" style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="font-size: 32px;">ğŸ“–</div>
                    <div style="text-align: left;">
                        <h2 style="font-size: 16px; font-weight: 500; margin: 0 0 4px 0; color: #2e7d32;">××™×š ×–×” ×¢×•×‘×“</h2>
                        <p style="font-size: 13px; color: #558b2f; margin: 0;">××“×¨×™×š ××¤×•×¨×˜ ×‘×¢×‘×¨×™×ª ×œ×”×©×ª××©×•×ª ×‘××¢×¨×›×ª</p>
                    </div>
                </div>
                <a href="https://myconfluence.mydomain.local/mypage/Yossarian+User+Guide+Hebrew" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="btn btn-success" 
                   style="font-size: 14px; padding: 10px 24px; white-space: nowrap;">
                    ğŸ“š ×¤×ª×— ××“×¨×™×š ××œ×
                </a>
            </div>
        </div>

        <!-- Getting Started Section -->
        <div class="card getting-started">
            <details>
                <summary>ğŸ¯ Getting Started - How to Use Yossarian</summary>
                <div class="getting-started-content">
                    
                    <!-- What Does Yossarian Do? -->
                    <div class="help-section">
                        <h3>ğŸ›¡ï¸ What Does Yossarian Do?</h3>
                        <p>
                            Yossarian automatically finds and removes sensitive information from your log files, 
                            making them safe to share with external support teams, vendors, or less-secure storage.
                        </p>
                        <p>
                            <strong>Think of it as a "redaction tool" for your technical files.</strong> 
                            Just like blacking out sensitive information in a document, Yossarian replaces 
                            sensitive data with safe placeholders while keeping your logs readable and useful.
                        </p>
                    </div>

                    <!-- What Gets Protected? -->
                    <div class="help-section">
                        <h3>ğŸ“‹ What Gets Protected?</h3>
                        <p>Yossarian automatically detects and protects:</p>
                        
                        <div class="example-box">
                            <div class="example-item">
                                <div class="example-label">ğŸŒ Network Addresses (IP Addresses)</div>
                                <div class="example-text before">Server at 192.168.1.100 crashed at midnight</div>
                                <div class="example-text after">Server at [IP-001] crashed at midnight</div>
                            </div>

                            <div class="example-item">
                                <div class="example-label">ğŸ‘¤ Usernames & Accounts</div>
                                <div class="example-text before">CORP\john.doe accessed the database</div>
                                <div class="example-text after">USN123456789 accessed the database</div>
                            </div>

                            <div class="example-item">
                                <div class="example-label">ğŸ”‘ Passwords & Credentials</div>
                                <div class="example-text before">password=MySecret123 user=admin</div>
                                <div class="example-text after">[PASSWORD-REDACTED] user=admin</div>
                            </div>

                            <div class="example-item">
                                <div class="example-label">ğŸ” Security Tokens & Keys</div>
                                <div class="example-text before">token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</div>
                                <div class="example-text after">token=[JWT-REDACTED]</div>
                            </div>

                            <div class="example-item">
                                <div class="example-label">ğŸ¢ Your Custom Sensitive Words</div>
                                <div class="example-text before">ProjectPhoenix deadline is next week</div>
                                <div class="example-text after">[SENSITIVE] deadline is next week</div>
                            </div>
                        </div>

                        <div class="tip-box">
                            <strong>ğŸ’¡ TIP:</strong> All replacements are consistent - if "192.168.1.100" appears 
                            100 times, it will always become "[IP-001]" so you can still track patterns!
                        </div>
                    </div>

                    <!-- File Size Limits -->
                    <div class="help-section">
                        <h3>ğŸ“¦ File Size Limits</h3>
                        <p>To ensure smooth processing, the following limits apply:</p>
                        
                        <div class="example-box">
                            <div class="example-item">
                                <div class="example-label">ğŸ“ Individual Files</div>
                                <p style="margin: 8px 0; font-size: 14px;">
                                    Maximum <strong id="helpMaxFileSize">50MB</strong> per file
                                </p>
                            </div>

                            <div class="example-item">
                                <div class="example-label">ğŸ“¦ ZIP Archives</div>
                                <p style="margin: 8px 0; font-size: 14px;">
                                    Files inside ZIP archives: Maximum <strong id="helpMaxZipFileSize">10MB</strong> each (uncompressed)
                                </p>
                            </div>

                            <div class="example-item">
                                <div class="example-label">ğŸ“Š Total Upload</div>
                                <p style="margin: 8px 0; font-size: 14px;">
                                    Maximum <strong id="helpMaxFileCount">10</strong> files, 
                                    <strong id="helpMaxTotalSize">100MB</strong> total
                                </p>
                            </div>
                        </div>

                        <div class="tip-box">
                            <strong>ğŸ’¡ TIP:</strong> If you have a very large ZIP file, consider extracting it first 
                            and uploading the individual log files instead. This gives you better control and 
                            allows larger individual files to be processed.
                        </div>
                    </div>

                    <!-- How to Use -->
                    <div class="help-section">
                        <h3>ğŸ“š How to Use Yossarian (3 Easy Steps)</h3>
                        
                        <ol class="step-list">
                            <li>
                                <strong>Add Your Custom Sensitive Words (Optional)</strong>
                                <p>
                                    If your files contain company-specific secrets like project codenames, 
                                    client names, or internal system names, add them in the "Personal Sensitive Words" 
                                    section below. This is completely optional - Yossarian will still protect 
                                    standard sensitive data without this step.
                                </p>
                            </li>
                            
                            <li>
                                <strong>Upload Your Files</strong>
                                <p>
                                    Drag and drop your log files, or click the upload area to browse. 
                                    Yossarian supports .log, .txt, .zip, .json, and other text files. 
                                    You can upload up to 10 files at once (max 50MB each).
                                </p>
                            </li>
                            
                            <li>
                                <strong>Download Protected Files</strong>
                                <p>
                                    Click "ğŸ”’ Sanitize Files" to process your uploads. Review the summary 
                                    to see what was protected, then download your cleaned files and the audit report. 
                                    The audit report shows exactly what was changed, so you can verify nothing 
                                    important was removed.
                                </p>
                            </li>
                        </ol>

                        <div class="tip-box">
                            <strong>âš ï¸ IMPORTANT:</strong> Always review the sanitized files before sharing them 
                            externally. While Yossarian catches common patterns, it's good practice to verify 
                            that all sensitive information has been properly protected.
                        </div>
                    </div>

                </div>
            </details>
        </div>

        <!-- Personal Sensitive Words -->
        <div class="card">
            <details>
                <summary style="padding: 20px 24px; font-size: 16px; font-weight: 500; color: var(--md-primary); cursor: pointer; list-style: none; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 14px; transition: transform 0.3s;" id="wordsToggleIcon">â–¶</span>
                    ğŸ” Personal Sensitive Words
                    <span style="font-size: 14px; color: var(--md-on-surface-variant); font-weight: 400;" id="wordsCount">(0 words stored)</span>
                </summary>
                
                <div class="card-content" style="padding-top: 0;">
                    <div class="card-subtitle" style="margin-bottom: 16px; color: var(--md-on-surface-variant);">
                        Add your own sensitive terms (stored encrypted in browser)
                    </div>
                    
                    <div class="status-message" id="wordsStatus"></div>
                    
                    <!-- Words Table -->
                    <div class="table-container" style="margin-bottom: 16px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Term</th>
                                    <th style="width: 40%;">Replacement</th>
                                    <th style="width: 20%; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="personalWordsTable">
                                <tr>
                                    <td colspan="3" style="text-align: center; color: var(--md-on-surface-variant); padding: 20px;">
                                        No personal words added yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Add New Word Form -->
                    <div style="background: var(--md-surface-variant); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 500; margin-bottom: 12px; color: var(--md-on-surface);">
                            â• Add New Word
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: var(--md-primary); margin-bottom: 6px;">
                                    TERM
                                </label>
                                <input 
                                    type="text" 
                                    id="newWordTerm" 
                                    placeholder="MyCompany"
                                    style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
                                />
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: var(--md-primary); margin-bottom: 6px;">
                                    REPLACEMENT
                                </label>
                                <input 
                                    type="text" 
                                    id="newWordReplacement" 
                                    placeholder="[SNIPPED]"
                                    style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
                                    onkeypress="if(event.key==='Enter') addPersonalWord()"
                                />
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addPersonalWord()">
                                â• Add
                            </button>
                        </div>
                        <div style="font-size: 12px; color: var(--md-on-surface-variant); margin-top: 8px;">
                            ğŸ’¡ Leave replacement empty to use default: [SNIPPED]
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- File Upload & Processing -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ğŸ“ Upload & Sanitize Files</h2>
                <div class="card-subtitle" id="uploadLimitsSubtitle">Support for multiple log files, archives (zip, tar.gz) â€¢ Loading limits...</div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“¤</div>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-subtext">Supports .log, .txt, .zip, .tar.gz and other text formats</div>
                    <input 
                        type="file" 
                        id="fileInput" 
                        class="file-input" 
                        multiple 
                        accept=".log,.txt,.zip,.tar,.gz,.tar.gz,.json,.xml,.csv"
                        aria-label="Upload files for sanitization"
                    >
                </div>

                <!-- Upload Status Messages -->
                <div class="status-message" id="uploadStatus"></div>

                <!-- File List -->
                <div class="file-list" id="fileList"></div>

                <!-- Progress Section -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-header">
                        <span class="progress-title">Processing Files...</span>
                        <span class="progress-stats" id="progressStats">0 / 0 files</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Preparing files...</div>
                </div>
                <!-- Detailed Report Option -->
                <div style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="detailedReportCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px; font-weight: 500;">Generate detailed replacement report (CSV)</span>
                    </label>
                    <div style="font-size: 12px; color: var(--md-on-surface-variant); margin-top: 4px; margin-left: 26px;">
                        Shows line numbers, original values, and replacements for learning
                    </div>
                </div>

                <div class="button-group" style="margin-top: 16px;">
                    <button type="button" class="btn btn-primary" id="processBtn" onclick="processFiles()" disabled>
                        ğŸ”’ Sanitize Files
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearFiles()">
                        ğŸ—‘ï¸ Clear Files
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“Š Sanitization Results</h2>
                    <div class="card-subtitle">Processing summary and detailed breakdown</div>
                </div>
                <div class="card-content">
                    <!-- Overall Summary -->
                    <div class="results-summary" id="resultsSummary">
                        <div class="metric-card">
                            <div class="metric-value" id="totalIPs">0</div>
                            <div class="metric-label">IP Addresses</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="totalAD">0</div>
                            <div class="metric-label">AD Accounts</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="totalJWT">0</div>
                            <div class="metric-label">JWT Tokens</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="totalKeys">0</div>
                            <div class="metric-label">Private Keys</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="totalSensitive">0</div>
                            <div class="metric-label">Sensitive Terms</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="totalTime">0ms</div>
                            <div class="metric-label">Processing Time</div>
                        </div>
                    </div>

                    <!-- Per-File Results -->
                    <div id="fileResults"></div>
                </div>
            </div>
        </div>

        <!-- Downloads -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">â¬‡ï¸ Downloads</h2>
                <div class="card-subtitle">Download sanitized files and audit reports</div>
            </div>
            <div class="card-content">
                <div class="download-grid">
                    <div class="download-card">
                        <div class="download-icon">ğŸ”’</div>
                        <div class="download-title">Sanitized Files</div>
                        <div class="download-description">Download your cleaned log files as a zip archive</div>
                        <div id="downloadButtons">
                            <!-- Dynamic download buttons will be populated here -->
                        </div>  
                    </div>
                    <div class="download-card">
                        <div class="download-icon">ğŸ“‹</div>
                        <div class="download-title">IP Mappings</div>
                        <div class="download-description">CSV report of all IP address mappings for audit trail</div>
                        <a href="/mappings/csv" class="btn btn-primary">
                            ğŸ“Š Download Mappings
                        </a>
                    </div>
                    <div class="download-card">
                        <div class="download-icon">ğŸ“ˆ</div>
                        <div class="download-title">Processing Report</div>
                        <div class="download-description">Detailed report of all sanitization activities</div>
                        <a href="#" class="btn btn-primary" id="downloadReport" onclick="generateReport()">
                            ğŸ“„ Generate Report
                        </a>
                    </div>
                    <div class="download-card" id="detailedReportCard" style="display: none;">
                        <div class="download-icon">ğŸ”</div>
                        <div class="download-title">Detailed Replacement Report</div>
                        <div class="download-description">Line-by-Line Changes - CSV</div>
                        <a href="/download/detailed-report" class="btn btn-success" id="downloadDetailedReport">
                            ğŸ“Š Download CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let selectedFiles = [];
        let processingResults = [];
        let totalProcessingTime = 0;
        
        // File upload limits (loaded from backend)
        let maxTotalUploadSizeMB = 100;
        let maxFileSizeMB = 50;
        let maxZipFileSizeMB = 10;
        let maxFileCount = 10;

        // Initialize on page load
        window.onload = function() {
            loadConfigLimits();
            displayPersonalWords(); // Load personal words table
            initializeFileUpload();
            createDownloadButtons(); // Initialize empty download section
        };
        
        // Load configuration limits from backend
        function loadConfigLimits() {
            fetch('/api/config')
                .then(r => r.json())
                .then(data => {
                    maxTotalUploadSizeMB = data.max_total_upload_size_mb || 100;
                    maxFileSizeMB = data.max_file_size_mb || 50;
                    maxZipFileSizeMB = data.max_zip_file_size_mb || 10;
                    maxFileCount = data.max_file_count || 10;
                    
                    // Update UI subtitle with actual limits
                    document.getElementById('uploadLimitsSubtitle').textContent = 
                        `Support for multiple log files, archives (zip, tar.gz) â€¢ Max ${maxFileSizeMB}MB per file â€¢ Files inside ZIP: ${maxZipFileSizeMB}MB â€¢ Up to ${maxFileCount} files`;
                    
                    // Update help section values if elements exist
                    const helpMaxFileSize = document.getElementById('helpMaxFileSize');
                    const helpMaxZipFileSize = document.getElementById('helpMaxZipFileSize');
                    const helpMaxFileCount = document.getElementById('helpMaxFileCount');
                    const helpMaxTotalSize = document.getElementById('helpMaxTotalSize');
                    
                    if (helpMaxFileSize) helpMaxFileSize.textContent = `${maxFileSizeMB}MB`;
                    if (helpMaxZipFileSize) helpMaxZipFileSize.textContent = `${maxZipFileSizeMB}MB`;
                    if (helpMaxFileCount) helpMaxFileCount.textContent = maxFileCount;
                    if (helpMaxTotalSize) helpMaxTotalSize.textContent = `${maxTotalUploadSizeMB}MB`;
                    
                    console.log('Config limits loaded:', data);
                })
                .catch(e => {
                    console.log('Failed to load config limits, using defaults:', e);
                    document.getElementById('uploadLimitsSubtitle').textContent = 
                        `Support for multiple log files, archives (zip, tar.gz) â€¢ Max 50MB per file â€¢ Files inside ZIP: 10MB â€¢ Up to 10 files`;
                });
        }
        // File Upload Handling
        function initializeFileUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.onclick = function(e) {
                if (e.target === this || e.target.classList.contains('upload-icon') || 
                    e.target.classList.contains('upload-text') || e.target.classList.contains('upload-subtext')) {
                    e.stopPropagation();
                    fileInput.click();
                }
            };

            // Drag and drop handlers
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            const fileArray = Array.from(files);
            
            // Validate file count
            if (fileArray.length > maxFileCount) {
                showStatus('error', `Maximum ${maxFileCount} files allowed. Please select fewer files.`, 'uploadStatus');
                return;
            }

            // Reset previous processing data
            selectedFiles = [];
            processingResults = [];
            document.getElementById('resultsSection').classList.remove('visible');
            document.getElementById('progressContainer').classList.remove('visible');
            
            // Clear server-side download cache when starting new upload
            fetch('/clear-download-cache', { method: 'POST' })
                .catch(err => console.log('Cache clear failed:', err));
            
            createDownloadButtons(); // Reset download section
            
            fileArray.forEach(file => {
                // Validate file size
                if (file.size > maxFileSizeMB * 1024 * 1024) {
                    showStatus('error', `File "${file.name}" exceeds ${maxFileSizeMB}MB limit and will be skipped.`, 'uploadStatus');
                    return;
                }

                // Basic binary detection
                const isBinary = file.type.startsWith('image/') || 
                                file.type.startsWith('video/') || 
                                file.type.startsWith('audio/') ||
                                file.type === 'application/octet-stream';

                if (isBinary && !isArchive(file)) {
                    showStatus('error', `File "${file.name}" appears to be binary and will be skipped.`);
                    return;
                }

                selectedFiles.push({
                    file: file,
                    id: Date.now() + Math.random(),
                    status: 'ready',
                    results: null
                });
            });

            displayFileList();
            updateProcessButton();
        }

        function isArchive(file) {
            const archiveTypes = ['.zip', '.tar', '.gz', '.tar.gz', '.rar', '.7z'];
            return archiveTypes.some(ext => file.name.toLowerCase().endsWith(ext));
        }

        function createDownloadButtons() {
            const downloadDiv = document.getElementById('downloadButtons');
            let buttonsHTML = '';
            
            // Add combined download button
            if (selectedFiles.some(f => f.status === 'complete')) {
                buttonsHTML += `
                    <a href="/download/sanitized" class="btn btn-success download-btn" style="margin-bottom: 10px;">
                        ğŸ“¦ Download All Files
                    </a>
                `;
            }
            
            // Add individual file download buttons
            selectedFiles.forEach(fileObj => {
                if (fileObj.status === 'complete') {
                    buttonsHTML += `
                        <a href="/download/sanitized/${encodeURIComponent(fileObj.file.name)}" 
                        class="btn btn-secondary download-btn" style="margin: 5px;">
                            ğŸ“„ ${fileObj.file.name}
                        </a>
                    `;
                }
            });
            
            if (buttonsHTML === '') {
                buttonsHTML = '<p style="color: #666;">No files processed yet</p>';
            }
            
            downloadDiv.innerHTML = buttonsHTML;
        }
        
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            const processBtn = document.getElementById('processBtn');

            if (selectedFiles.length === 0) {
                fileList.classList.remove('visible');
                return;
            }

            fileList.classList.add('visible');
            fileList.innerHTML = selectedFiles.map(fileObj => {
                const file = fileObj.file;
                const sizeStr = formatFileSize(file.size);
                const typeIcon = getFileIcon(file.name);

                return `
                    <div class="file-item" data-file-id="${fileObj.id}">
                        <div class="file-info">
                            <div class="file-icon">${typeIcon}</div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${sizeStr}</div>
                            </div>
                        </div>
                        <div class="file-status ${fileObj.status}">${getStatusText(fileObj.status)}</div>
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const iconMap = {
                'log': 'LOG',
                'txt': 'TXT',
                'zip': 'ZIP',
                'tar': 'TAR',
                'gz': 'GZ',
                'json': 'JSON',
                'xml': 'XML',
                'csv': 'CSV'
            };
            return iconMap[ext] || 'FILE';
        }

        function getStatusText(status) {
            const statusMap = {
                'ready': 'Ready',
                'processing': 'Processing...',
                'complete': 'Complete',
                'error': 'Error'
            };
            return statusMap[status] || status;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = selectedFiles.length === 0;
        }

        function clearFiles() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('fileList').classList.remove('visible');
            document.getElementById('progressContainer').classList.remove('visible');
            document.getElementById('resultsSection').classList.remove('visible');
            document.getElementById('detailedReportCard').style.display = 'none';
            document.getElementById('detailedReportCheckbox').checked = false;
            
            // Reset button state
            const processBtn = document.getElementById('processBtn');
            const uploadZone = document.getElementById('uploadZone');
            processBtn.disabled = false;
            processBtn.textContent = 'ğŸ”’ Sanitize Files';
            processBtn.style.opacity = '1';
            uploadZone.classList.remove('processing');
            uploadZone.style.pointerEvents = 'auto';
            
            updateProcessButton();
            
            // Clear download files from server
            fetch('/clear-download-cache', { method: 'POST' })
                .catch(err => console.log('Cache clear failed:', err));
            
            // Clear download buttons
            createDownloadButtons();
        }

        // File Processing
        async function processFiles() {
            if (selectedFiles.length === 0) return;

            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressStats = document.getElementById('progressStats');
            const processBtn = document.getElementById('processBtn');
            const uploadZone = document.getElementById('uploadZone');

            // Disable UI during processing
            processBtn.disabled = true;
            processBtn.textContent = 'â³ Processing...';
            processBtn.style.opacity = '0.6';
            uploadZone.classList.add('processing');
            uploadZone.style.pointerEvents = 'none';

            progressContainer.classList.add('visible');
            processingResults = [];
            totalProcessingTime = 0;

            const startTime = Date.now();

            for (let i = 0; i < selectedFiles.length; i++) {
                const fileObj = selectedFiles[i];
                const progress = ((i) / selectedFiles.length) * 100;

                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Processing ${fileObj.file.name}... (${Math.round(progress)}%)`;
                progressStats.textContent = `${i} / ${selectedFiles.length} files`;

                fileObj.status = 'processing';
                updateFileStatus(fileObj.id, 'processing');

                try {
                    const result = await processFile(fileObj.file);
                    
                    // Handle both old single-file and new multi-file response formats
                    if (result.files && Array.isArray(result.files)) {
                        // New multi-file format
                        result.files.forEach(fileResult => {
                            fileObj.results = fileResult;
                            processingResults.push(fileResult);
                        });
                    } else {
                        // Old single-file format (fallback)
                        fileObj.results = result;
                        processingResults.push(result);
                    }
                    
                    fileObj.status = 'complete';
                    updateFileStatus(fileObj.id, 'complete');
                } catch (error) {
                    console.error('Processing error:', error);
                    fileObj.status = 'error';
                    updateFileStatus(fileObj.id, 'error');
                    showStatus('error', `Failed to process ${fileObj.file.name}: ${error.message}`);
                }
            }

            // Always re-enable UI, even if there were errors
            processBtn.disabled = false;
            processBtn.textContent = 'ğŸ”’ Sanitize Files';
            processBtn.style.opacity = '1';
            uploadZone.classList.remove('processing');
            uploadZone.style.pointerEvents = 'auto';

            const endTime = Date.now();
            totalProcessingTime = endTime - startTime;
            
            progressFill.style.width = '100%';
            progressText.textContent = `Completed in ${(totalProcessingTime / 1000).toFixed(2)}s`;
            progressStats.textContent = `${selectedFiles.length} / ${selectedFiles.length} files`;

            // Re-enable UI
            processBtn.disabled = false;
            processBtn.textContent = 'ğŸ”’ Sanitize Files';
            processBtn.style.opacity = '1';
            uploadZone.classList.remove('processing');
            uploadZone.style.pointerEvents = 'auto';

            displayResults();
            enableDownloads();
        }

        async function processFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // Add detailed report flag
            const detailedReportEnabled = document.getElementById('detailedReportCheckbox').checked;
            formData.append('generate_detailed_report', detailedReportEnabled ? 'true' : 'false');
            
            // Add personal sensitive words from new format
            const personalWords = getPersonalWordsForSanitization();
            if (personalWords) {
                // Set as cookie for backend to read
                setCookie('sensitive_words', personalWords, 1); // 1 day expiry
            }

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        function updateFileStatus(fileId, status) {
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem) {
                const statusElement = fileItem.querySelector('.file-status');
                statusElement.className = `file-status ${status}`;
                statusElement.textContent = getStatusText(status);
            }
        }

        // Results Display
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('visible');

            const aggregated = {
                totalIPs: 0,
                totalAD: 0,
                totalJWT: 0,
                totalKeys: 0,
                totalSensitive: 0,
                totalUserWords: 0,
                totalFiles: processingResults.length,
                totalSize: 0,
                totalSanitizedSize: 0
            };

            processingResults.forEach(result => {
                aggregated.totalIPs += result.total_ips || result.ip_addresses || 0;
                aggregated.totalAD += result.ad_accounts || result.ad_account_count || 0;
                aggregated.totalJWT += result.jwt_tokens || result.jwt_token_count || 0;
                aggregated.totalKeys += result.private_keys || result.private_key_count || 0;
                aggregated.totalSensitive += result.sensitive_terms || result.sensitive_term_count || 0;
                aggregated.totalUserWords += result.user_words || result.user_word_count || 0;
                aggregated.totalSize += result.original_size || 0;
                aggregated.totalSanitizedSize += result.sanitized_size || 0;
            });

            document.getElementById('totalIPs').textContent = aggregated.totalIPs;
            document.getElementById('totalAD').textContent = aggregated.totalAD;
            document.getElementById('totalJWT').textContent = aggregated.totalJWT;
            document.getElementById('totalKeys').textContent = aggregated.totalKeys;
            document.getElementById('totalSensitive').textContent = aggregated.totalSensitive;
            document.getElementById('totalTime').textContent = `${(totalProcessingTime / 1000).toFixed(2)}s`;

            displayFileResults();
            createDownloadButtons();
        }

        function displayFileResults() {
            const fileResults = document.getElementById('fileResults');
            
            const resultsHTML = selectedFiles.map(fileObj => {
                if (!fileObj.results) return '';

                const result = fileObj.results;
                const processingTime = result.processing_time || 'N/A';

                return `
                    <div class="file-results">
                        <div class="file-result-header">
                            <span class="file-result-name">ğŸ“„ ${fileObj.file.name}</span>
                            <span class="file-result-time">â±ï¸ ${processingTime}</span>
                        </div>
                        <div class="file-result-content">
                            <div class="categories-grid">
                                <div class="category-item">
                                    <span class="category-name">IP Addresses</span>
                                    <span class="category-count">${result.total_ips || 0}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">AD Accounts</span>
                                    <span class="category-count">${result.ad_accounts || 0}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">JWT Tokens</span>
                                    <span class="category-count">${result.jwt_tokens || 0}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">Private Keys</span>
                                    <span class="category-count">${result.private_keys || 0}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">Sensitive Terms</span>
                                    <span class="category-count">${result.sensitive_terms || 0}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">User Words</span>
                                    <span class="category-count">${result.user_words || 0}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">Original Size</span>
                                    <span class="category-count">${formatFileSize(result.original_size || 0)}</span>
                                </div>
                                <div class="category-item">
                                    <span class="category-name">Sanitized Size</span>
                                    <span class="category-count">${formatFileSize(result.sanitized_size || 0)}</span>
                                </div>
                            </div>
                            ${result.sample ? `
                                <div style="margin-top: 16px;">
                                    <div style="font-size: 12px; color: var(--md-on-surface-variant); margin-bottom: 8px;">SAMPLE OUTPUT:</div>
                                    <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto;">
                                        ${escapeHtml(result.sample)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            fileResults.innerHTML = resultsHTML;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function enableDownloads() {
            // Enable download buttons after successful processing
            const downloadButtons = document.querySelectorAll('.download-btn');
            downloadButtons.forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                btn.classList.remove('disabled');
            });
            
            // Show detailed report card if it was generated
            const detailedReportEnabled = document.getElementById('detailedReportCheckbox').checked;
            if (detailedReportEnabled) {
                document.getElementById('detailedReportCard').style.display = 'block';
            }
            
            // Create download buttons for individual files
            createDownloadButtons();
        }

        // ============================================
        // PERSONAL SENSITIVE WORDS MANAGEMENT
        // ============================================
        
        // Simple XOR encryption for localStorage
        function encryptWords(text) {
            const key = 'yossarian-' + window.location.hostname;
            return btoa(text.split('').map((c, i) => 
                String.fromCharCode(c.charCodeAt(0) ^ key.charCodeAt(i % key.length))
            ).join(''));
        }
        
        function decryptWords(encrypted) {
            const key = 'yossarian-' + window.location.hostname;
            try {
                return atob(encrypted).split('').map((c, i) => 
                    String.fromCharCode(c.charCodeAt(0) ^ key.charCodeAt(i % key.length))
                ).join('');
            } catch (e) {
                return null;
            }
        }
        
        // Get personal words from encrypted localStorage
        function getPersonalWords() {
            try {
                const encrypted = localStorage.getItem('personal_sensitive_words');
                if (!encrypted) return [];
                
                const decrypted = decryptWords(encrypted);
                if (!decrypted) return [];
                
                return JSON.parse(decrypted);
            } catch (e) {
                console.error('Failed to load personal words:', e);
                return [];
            }
        }
        
        // Save personal words to encrypted localStorage
        function savePersonalWords(words) {
            try {
                const json = JSON.stringify(words);
                const encrypted = encryptWords(json);
                localStorage.setItem('personal_sensitive_words', encrypted);
                return true;
            } catch (e) {
                console.error('Failed to save personal words:', e);
                return false;
            }
        }
        
        // Display personal words in table
        function displayPersonalWords() {
            const words = getPersonalWords();
            const tbody = document.getElementById('personalWordsTable');
            const countSpan = document.getElementById('wordsCount');
            
            countSpan.textContent = `(${words.length} word${words.length !== 1 ? 's' : ''} stored)`;
            
            if (words.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--md-on-surface-variant); padding: 20px;">
                            No personal words added yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = words.map((word, index) => `
                <tr>
                    <td><code style="background: var(--md-surface-variant); padding: 4px 8px; border-radius: 4px;">${escapeHtml(word.term)}</code></td>
                    <td><code style="background: var(--md-surface-variant); padding: 4px 8px; border-radius: 4px;">${escapeHtml(word.replacement)}</code></td>
                    <td style="text-align: center;">
                        <button class="btn btn-error" style="padding: 6px 12px; font-size: 12px;" onclick="removePersonalWord(${index})">
                            ğŸ—‘ï¸ Remove
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Add new personal word
        function addPersonalWord() {
            const termInput = document.getElementById('newWordTerm');
            const replacementInput = document.getElementById('newWordReplacement');
            
            const term = termInput.value.trim();
            const replacement = replacementInput.value.trim() || '[SNIPPED]';
            
            if (!term) {
                showStatus('error', 'Please enter a term', 'wordsStatus');
                return;
            }
            
            // Check for duplicates
            const words = getPersonalWords();
            if (words.some(w => w.term.toLowerCase() === term.toLowerCase())) {
                showStatus('error', `Term "${term}" already exists`, 'wordsStatus');
                return;
            }
            
            // Add word
            words.push({ term, replacement });
            
            if (savePersonalWords(words)) {
                showStatus('success', `Added "${term}" â†’ "${replacement}"`, 'wordsStatus');
                termInput.value = '';
                replacementInput.value = '';
                displayPersonalWords();
            } else {
                showStatus('error', 'Failed to save word', 'wordsStatus');
            }
        }
        
        // Remove personal word
        function removePersonalWord(index) {
            const words = getPersonalWords();
            const removed = words.splice(index, 1)[0];
            
            if (savePersonalWords(words)) {
                showStatus('success', `Removed "${removed.term}"`, 'wordsStatus');
                displayPersonalWords();
            } else {
                showStatus('error', 'Failed to remove word', 'wordsStatus');
            }
        }
        
        // Get words as comma-separated string (for backend)
        function getPersonalWordsForSanitization() {
            const words = getPersonalWords();
            return words.map(w => w.term).join(',');
        }
        
        // Legacy function support (deprecated but keeping for compatibility)
        function loadWords() {
            const words = getCookie('sensitive_words');
            if (words) {
                document.getElementById('sensitiveWords').value = words.replace(/,/g, ', ');
            }
        }

        function saveWords() {
            const words = document.getElementById('sensitiveWords').value;
            const cleanWords = words.split(',').map(w => w.trim()).filter(w => w).join(',');
            setCookie('sensitive_words', cleanWords, 30);
            showStatus('success', 'Sensitive words saved successfully!', 'wordsStatus');
        }

        function clearWords() {
            document.getElementById('sensitiveWords').value = '';
            setCookie('sensitive_words', '', -1);
            showStatus('success', 'Sensitive words cleared!', 'wordsStatus');
        }

        // Utility Functions
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const cookies = document.cookie.split(';');
            for(let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.indexOf(nameEQ) === 0) {
                    return cookie.substring(nameEQ.length);
                }
            }
            return null;
        }

        function showStatus(type, message, elementId = null) {
            const statusElement = document.getElementById(elementId || 'mainStatus');
            if (!statusElement) {
                // Create a temporary status element if none specified
                const tempStatus = document.createElement('div');
                tempStatus.className = `status-message visible ${type}`;
                tempStatus.textContent = message;
                document.querySelector('.container').appendChild(tempStatus);
                setTimeout(() => tempStatus.remove(), 5000);
                return;
            }

            statusElement.className = `status-message visible ${type}`;
            statusElement.textContent = message;
            
            setTimeout(() => {
                statusElement.classList.remove('visible');
            }, 5000);
        }

        // Report Generation
        function generateReport() {
            if (processingResults.length === 0) {
                showStatus('error', 'No processing results available. Please process files first.');
                return;
            }

            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalFiles: selectedFiles.length,
                    processingTime: totalProcessingTime,
                    totalFindings: processingResults.reduce((sum, r) => sum + (r.total_ips || 0) + (r.ad_accounts || 0) + (r.jwt_tokens || 0) + (r.private_keys || 0) + (r.sensitive_terms || 0), 0)
                },
                files: selectedFiles.map(fileObj => {
                // Clean results for report (exclude binary content)
                const cleanResults = fileObj.results ? {...fileObj.results} : null;
                if (cleanResults && cleanResults.sanitized_content) {
                    delete cleanResults.sanitized_content;
                }
                return {
                    filename: fileObj.file.name,
                    size: fileObj.file.size,
                    status: fileObj.status,
                    results: cleanResults
                };
            })
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `yossarian-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('success', 'Processing report downloaded successfully!');
        }

        // Initialize user info (if authenticated)
        function initializeUserInfo() {
            // This would be populated by server-side template or API call
            // For now, it's hidden by default
            const userBanner = document.getElementById('userBanner');
            // userBanner.style.display = 'block';
            // document.getElementById('userName').textContent = 'John Doe';
        }
        // Load version info
        fetch('/health')
            .then(r => r.json())
            .then(data => {
                if (data.version) {
                    document.getElementById('version').textContent = `(${data.version})`;
                }
            })
            .catch(() => {});
        // Load user info
        fetch('/api/userinfo')
            .then(r => r.json())
            .then(data => {
                if (data.authenticated) {
                    document.getElementById('username').textContent = 'ğŸ‘¤ ' + data.username;
                    document.getElementById('logoutLink').style.display = 'inline';
                }
            })
            .catch(() => {});
    </script>
</body>
</html>