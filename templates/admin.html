<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Yossarian Go</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <style>
        /* Material Design 3 - Matching SPA */
        :root {
            --md-primary: #1976d2;
            --md-primary-container: #d3e4f7;
            --md-on-primary: #ffffff;
            --md-on-primary-container: #001d36;
            
            --md-secondary: #535f70;
            --md-secondary-container: #d7e3f7;
            
            --md-surface: #fdfbff;
            --md-surface-1: #f4f8fd;
            --md-surface-2: #eff3f9;
            --md-surface-3: #eaeef4;
            --md-surface-4: #e8ecf2;
            --md-surface-5: #e5e9ef;
            
            --md-on-surface: #1a1c1e;
            --md-on-surface-variant: #42474e;
            
            --md-outline: #72777f;
            --md-outline-variant: #c2c7cf;
            
            --md-success: #2e7d32;
            --md-warning: #f57c00;
            --md-error: #ba1a1a;
            
            --md-elevation-1: 0 1px 2px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --md-elevation-2: 0 1px 3px rgba(0,0,0,0.05), 0 2px 6px rgba(0,0,0,0.1);
            --md-elevation-3: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--md-surface);
            color: var(--md-on-surface);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Layout Container */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Navigation Rail */
        .nav-rail {
            background: var(--md-surface-1);
            border-right: 1px solid var(--md-outline-variant);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            z-index: 100;
        }

        .nav-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
            color: var(--md-primary);
        }

        .nav-brand-icon { font-size: 32px; }

        .nav-brand-badge {
            background: var(--md-error);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .nav-items {
            flex: 1;
            padding: 16px 8px;
            overflow-y: auto;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 16px 8px;
            margin-top: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 28px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            color: var(--md-on-surface-variant);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            user-select: none;
        }

        .nav-item:hover { background: var(--md-surface-3); }

        .nav-item.active {
            background: var(--md-secondary-container);
            color: var(--md-on-primary-container);
        }

        .nav-item-icon {
            font-size: 24px;
            width: 24px;
            text-align: center;
        }

        .nav-footer {
            padding: 16px;
            border-top: 1px solid var(--md-outline-variant);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            background: var(--md-surface-2);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--md-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-details { flex: 1; min-width: 0; }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        /* Main Content Area */
        .main-content {
            background: var(--md-surface);
            position: relative;
        }

        .panel {
            display: none;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header { margin-bottom: 32px; }

        .panel-title {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 8px;
            color: var(--md-on-surface);
        }

        .panel-subtitle {
            font-size: 16px;
            color: var(--md-on-surface-variant);
        }

        /* Material Cards */
        .md-card {
            background: var(--md-surface-1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--md-elevation-1);
            transition: box-shadow 0.2s;
        }

        .md-card:hover { box-shadow: var(--md-elevation-2); }

        .md-card-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .md-card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .md-card-subtitle {
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border-left: 4px solid var(--md-primary);
            box-shadow: var(--md-elevation-1);
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--md-elevation-2);
        }

        .stat-card.success { border-left-color: var(--md-success); }
        .stat-card.warning { border-left-color: var(--md-warning); }
        .stat-card.error { border-left-color: var(--md-error); }

        .stat-icon { font-size: 32px; margin-bottom: 12px; }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--md-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Buttons */
        .md-button {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
        }

        .md-button-filled {
            background: var(--md-primary);
            color: var(--md-on-primary);
            box-shadow: var(--md-elevation-1);
        }

        .md-button-filled:hover {
            background: #1565c0;
            box-shadow: var(--md-elevation-2);
        }

        .md-button-outlined {
            background: transparent;
            color: var(--md-primary);
            border: 1px solid var(--md-outline);
        }

        .md-button-outlined:hover {
            background: var(--md-primary-container);
        }

        .md-button-success {
            background: var(--md-success);
            color: white;
        }

        .md-button-success:hover { background: #1b5e20; }

        .md-button-warning {
            background: var(--md-warning);
            color: white;
        }

        .md-button-warning:hover { background: #e65100; }

        .md-button-error {
            background: var(--md-error);
            color: white;
        }

        .md-button-error:hover { background: #7f0000; }

        .md-button-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Health Indicators */
        .health-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .health-indicator.healthy { background: #e8f5e9; color: var(--md-success); }
        .health-indicator.warning { background: #fff3e0; color: var(--md-warning); }
        .health-indicator.error { background: #ffebee; color: var(--md-error); }
        .health-indicator.info { background: #e3f2fd; color: var(--md-primary); }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--md-elevation-1);
            max-height: 400px;
            overflow-y: auto;
        }

        .md-table {
            width: 100%;
            border-collapse: collapse;
        }

        .md-table th, .md-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .md-table th {
            background: var(--md-surface-2);
            font-weight: 500;
            font-size: 13px;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .md-table td { font-size: 14px; }

        .md-table tbody tr:hover { background: var(--md-surface-1); }

        .md-table code {
            background: var(--md-surface-3);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        /* Form Controls */
        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--md-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--md-outline-variant);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-input::placeholder { color: var(--md-outline); }

        textarea.form-input {
            resize: vertical;
            min-height: 120px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 0;
        }

        .form-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--md-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        /* Status Messages */
        .status-message {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .status-message.visible { display: flex; align-items: center; gap: 12px; }

        .status-message.success {
            background: #e8f5e9;
            color: var(--md-success);
            border-left: 4px solid var(--md-success);
        }

        .status-message.error {
            background: #ffebee;
            color: var(--md-error);
            border-left: 4px solid var(--md-error);
        }

        .status-message.info {
            background: #e3f2fd;
            color: var(--md-primary);
            border-left: 4px solid var(--md-primary);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* System Info Grid */
        .system-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .system-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--md-elevation-1);
        }

        .system-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .system-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--md-surface-3);
        }

        .system-item:last-child { border-bottom: none; }

        .system-item-label {
            font-size: 13px;
            color: var(--md-on-surface-variant);
        }

        .system-item-value {
            font-size: 13px;
            font-weight: 500;
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* Button Groups */
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        /* Preview Box */
        .preview-box {
            background: white;
            border: 2px solid var(--md-primary);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        .preview-box-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--md-on-surface-variant);
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--md-surface-3);
            border-top-color: var(--md-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .nav-rail {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: auto;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--md-outline-variant);
                z-index: 1000;
            }

            .nav-header, .nav-footer { display: none; }

            .nav-items {
                display: flex;
                justify-content: space-around;
                padding: 8px;
                overflow-x: auto;
            }

            .nav-item {
                flex-direction: column;
                padding: 8px 12px;
                font-size: 11px;
                gap: 4px;
                border-radius: 12px;
            }

            .nav-item-icon { font-size: 20px; }

            .main-content { padding-bottom: 80px; }

            .panel { padding: 20px; }

            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Navigation Rail -->
        <nav class="nav-rail">
            <div class="nav-header">
                <div class="nav-brand">
                    <span class="nav-brand-icon">üõ°Ô∏è</span>
                    <span>Yossarian</span>
                    <span class="nav-brand-badge">ADMIN</span>
                </div>
            </div>
            
            <div class="nav-items">
                <a class="nav-item active" data-panel="dashboard">
                    <span class="nav-item-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" data-panel="ad-accounts">
                    <span class="nav-item-icon">üë•</span>
                    <span>AD Accounts</span>
                </a>
                <a class="nav-item" data-panel="sensitive-terms">
                    <span class="nav-item-icon">üîí</span>
                    <span>Sensitive Terms</span>
                </a>
                <a class="nav-item" data-panel="organization">
                    <span class="nav-item-icon">üè¢</span>
                    <span>Organization</span>
                </a>
                
                <div class="nav-section-title">System</div>
                
                <a class="nav-item" data-panel="system">
                    <span class="nav-item-icon">‚öôÔ∏è</span>
                    <span>System Info</span>
                </a>
                <a class="nav-item" data-panel="api-keys">
                    <span class="nav-item-icon">üîë</span>
                    <span>API Keys</span>
                </a>
            </div>
            
            <div class="nav-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Administrator</div>
                        <div class="user-role" id="userRole">Admin</div>
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <a href="/" class="md-button md-button-outlined md-button-sm" style="flex: 1; justify-content: center;">
                        üè† Main App
                    </a>
                    <a href="/admin/logout" class="md-button md-button-outlined md-button-sm" style="flex: 1; justify-content: center;">
                        üö™ Logout
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Panel -->
            <div id="dashboard" class="panel active">
                <div class="panel-header">
                    <h1 class="panel-title">Dashboard</h1>
                    <p class="panel-subtitle">System overview and quick actions</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üó∫Ô∏è</div>
                        <div class="stat-value" id="statIPMappings">-</div>
                        <div class="stat-label">Active IP Mappings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-value" id="statUsers">-</div>
                        <div class="stat-label">AD Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíª</div>
                        <div class="stat-value" id="statComputers">-</div>
                        <div class="stat-label">AD Computers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîí</div>
                        <div class="stat-value" id="statSensitiveTerms">-</div>
                        <div class="stat-label">Sensitive Terms</div>
                    </div>
                </div>

                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">System Status</h2>
                        <p class="md-card-subtitle">Real-time service health and connectivity</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-icon">üè•</div>
                            <div class="stat-value">
                                <span class="health-indicator healthy" id="healthStatus">‚óè Healthy</span>
                            </div>
                            <div class="stat-label">Service Health</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üîó</div>
                            <div class="stat-value">
                                <span class="health-indicator info" id="ldapStatus">‚óè Checking...</span>
                            </div>
                            <div class="stat-label">LDAP Connection</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üîê</div>
                            <div class="stat-value">
                                <span class="health-indicator info" id="authStatus">‚óè Checking...</span>
                            </div>
                            <div class="stat-label">Authentication</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-value" id="versionInfo">-</div>
                            <div class="stat-label">Version</div>
                        </div>
                    </div>

                    <div class="status-message" id="dashboardStatus"></div>

                    <div class="button-group">
                        <button class="md-button md-button-success" onclick="syncAD()">üîÑ Sync AD Accounts</button>
                        <button class="md-button md-button-warning" onclick="testLDAP()">üß™ Test LDAP</button>
                        <button class="md-button md-button-filled" onclick="exportMappings()">üì§ Export IP Mappings</button>
                        <a href="/docs" target="_blank" class="md-button md-button-outlined">üìö API Docs</a>
                    </div>
                </div>
            </div>

            <!-- AD Accounts Panel -->
            <div id="ad-accounts" class="panel">
                <div class="panel-header">
                    <h1 class="panel-title">AD Accounts</h1>
                    <p class="panel-subtitle">Active Directory user and computer account mappings (<span id="accountCount">0</span> total)</p>
                </div>

                <div class="status-message" id="adStatus"></div>

                <div class="button-group">
                    <button class="md-button md-button-filled" onclick="refreshADAccounts()">üîÑ Refresh</button>
                    <button class="md-button md-button-outlined" onclick="exportADAccounts()">üì§ Export CSV</button>
                    <button class="md-button md-button-success" onclick="syncAD()">‚ö° Full Sync</button>
                </div>

                <div class="table-container">
                    <table class="md-table">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>USN</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="adAccountsTable">
                            <tr><td colspan="3" class="loading"><span class="loading-spinner"></span>Loading AD accounts...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sensitive Terms Panel -->
            <div id="sensitive-terms" class="panel">
                <div class="panel-header">
                    <h1 class="panel-title">Sensitive Terms</h1>
                    <p class="panel-subtitle">Organization-wide patterns to sanitize (<span id="termsCount">0</span> total)</p>
                </div>

                <div class="status-message" id="termsStatus"></div>

                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">Add New Term</h2>
                        <p class="md-card-subtitle">Define a pattern and its replacement text</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Sensitive Term</label>
                            <input type="text" id="newTerm" class="form-input" placeholder="e.g., ProjectApollo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Replacement</label>
                            <input type="text" id="newReplacement" class="form-input" placeholder="[SENSITIVE]">
                        </div>
                        <div class="form-group">
                            <button class="md-button md-button-filled" onclick="addSensitiveTerm()">‚ûï Add Term</button>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="md-button md-button-filled" onclick="refreshSensitiveTerms()">üîÑ Refresh</button>
                    <button class="md-button md-button-outlined" onclick="exportSensitiveTerms()">üì§ Export CSV</button>
                    <button class="md-button md-button-success" onclick="importSensitiveTerms()">üì• Import CSV</button>
                </div>

                <div class="table-container">
                    <table class="md-table">
                        <thead>
                            <tr>
                                <th>Term</th>
                                <th>Replacement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sensitiveTermsTable">
                            <tr><td colspan="3" class="loading"><span class="loading-spinner"></span>Loading sensitive terms...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Organization Panel -->
            <div id="organization" class="panel">
                <div class="panel-header">
                    <h1 class="panel-title">Organization Settings</h1>
                    <p class="panel-subtitle">Configure organization-wide disclaimer and documentation links</p>
                </div>

                <div class="status-message" id="orgStatus"></div>

                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">‚ö†Ô∏è Disclaimer Settings</h2>
                        <p class="md-card-subtitle">Display a warning banner on the main application</p>
                    </div>

                    <label class="form-checkbox">
                        <input type="checkbox" id="disclaimerEnabled">
                        <span>Show disclaimer on main page</span>
                    </label>

                    <div class="form-group">
                        <label class="form-label">Disclaimer Text</label>
                        <textarea id="disclaimerText" class="form-input" placeholder="**Warning**: This system processes sensitive data..."></textarea>
                        <p style="font-size: 12px; color: var(--md-on-surface-variant); margin-top: 8px;">
                            üí° Supports Markdown: **bold**, *italic*, [links](url)
                        </p>
                    </div>
                </div>

                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">üìö Documentation Settings</h2>
                        <p class="md-card-subtitle">Link to your organization's documentation</p>
                    </div>

                    <label class="form-checkbox">
                        <input type="checkbox" id="docsEnabled">
                        <span>Show documentation link on main page</span>
                    </label>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Documentation Title</label>
                            <input type="text" id="docsTitle" class="form-input" placeholder="User Guide">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Documentation URL</label>
                            <input type="url" id="docsUrl" class="form-input" placeholder="https://docs.example.com/yossarian">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="md-button md-button-filled" onclick="saveOrgSettings()">üíæ Save All Settings</button>
                </div>

                <div class="preview-box">
                    <div class="preview-box-title">üëÅÔ∏è Preview</div>
                    <div id="orgPreview">
                        <p style="color: var(--md-on-surface-variant);">Enable settings above to see preview...</p>
                    </div>
                </div>
            </div>

            <!-- System Panel -->
            <div id="system" class="panel">
                <div class="panel-header">
                    <h1 class="panel-title">System Information</h1>
                    <p class="panel-subtitle">Configuration, environment, and runtime details</p>
                </div>

                <div class="system-grid" id="systemInfo">
                    <div class="system-section">
                        <div class="system-section-title">üè∑Ô∏è Version Information</div>
                        <div class="system-item">
                            <span class="system-item-label">Version</span>
                            <span class="system-item-value" id="sysVersion">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Build Time</span>
                            <span class="system-item-value" id="sysBuildTime">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Git Commit</span>
                            <span class="system-item-value" id="sysGitCommit">-</span>
                        </div>
                    </div>

                    <div class="system-section">
                        <div class="system-section-title">üîê Authentication</div>
                        <div class="system-item">
                            <span class="system-item-label">Mode</span>
                            <span class="system-item-value" id="sysAuthMode">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">OIDC Enabled</span>
                            <span class="system-item-value" id="sysOIDC">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Auto SSO</span>
                            <span class="system-item-value" id="sysAutoSSO">-</span>
                        </div>
                    </div>

                    <div class="system-section">
                        <div class="system-section-title">üìÅ File Limits</div>
                        <div class="system-item">
                            <span class="system-item-label">Max Total Upload</span>
                            <span class="system-item-value" id="sysMaxTotal">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Max File Size</span>
                            <span class="system-item-value" id="sysMaxFile">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Max File Count</span>
                            <span class="system-item-value" id="sysMaxCount">-</span>
                        </div>
                    </div>

                    <div class="system-section">
                        <div class="system-section-title">üîó LDAP Configuration</div>
                        <div class="system-item">
                            <span class="system-item-label">Status</span>
                            <span class="system-item-value" id="sysLdapStatus">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Server</span>
                            <span class="system-item-value" id="sysLdapServer">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Sync Interval</span>
                            <span class="system-item-value" id="sysLdapInterval">-</span>
                        </div>
                    </div>

                    <div class="system-section">
                        <div class="system-section-title">üì¶ MinIO Storage</div>
                        <div class="system-item">
                            <span class="system-item-label">Endpoint</span>
                            <span class="system-item-value" id="sysMinioEndpoint">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Bucket</span>
                            <span class="system-item-value" id="sysMinioBucket">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">SSL</span>
                            <span class="system-item-value" id="sysMinioSSL">-</span>
                        </div>
                    </div>

                    <div class="system-section">
                        <div class="system-section-title">üåê Services</div>
                        <div class="system-item">
                            <span class="system-item-label">AD Service</span>
                            <span class="system-item-value" id="sysADService">-</span>
                        </div>
                        <div class="system-item">
                            <span class="system-item-label">Mode</span>
                            <span class="system-item-value" id="sysRunMode">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Keys Panel -->
			<div id="api-keys" class="panel">
                <div class="panel-header">
                    <h1 class="panel-title">API Keys</h1>
                    <p class="panel-subtitle">Manage API keys for pipeline and automation access</p>
                </div>

                <div id="apiKeysStatus" class="status-message"></div>

                <!-- Create New Key -->
                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">‚ûï Create New API Key</h2>
                        <p class="md-card-subtitle">Generate a new key for automated access</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Key Name *</label>
                        <input type="text" id="apiKeyName" class="form-input" placeholder="e.g., CI/CD Pipeline, Monitoring Script">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Scopes</label>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="scopeRead" checked> Read
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="scopeWrite" checked> Write
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="scopeAdmin"> Admin
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Expiry (optional)</label>
                        <select id="apiKeyExpiry" class="form-input">
                            <option value="0">Never expires</option>
                            <option value="24">24 hours</option>
                            <option value="168">7 days</option>
                            <option value="720">30 days</option>
                            <option value="2160">90 days</option>
                            <option value="8760">1 year</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button onclick="createAPIKey()" class="md-button md-button-filled">üîë Generate API Key</button>
                    </div>

                    <!-- New Key Display (hidden by default) -->
                    <div id="newKeyDisplay" style="display: none; margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-radius: 12px; border: 2px solid var(--md-warning);">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: var(--md-warning);">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <strong>Save this key now - it won't be shown again!</strong>
                        </div>
                        <div style="background: white; padding: 12px 16px; border-radius: 8px; font-family: 'SF Mono', Monaco, monospace; font-size: 14px; word-break: break-all; margin-bottom: 12px;">
                            <code id="newKeyValue"></code>
                        </div>
                        <button onclick="copyAPIKey()" class="md-button md-button-outlined" style="width: 100%;">
                            üìã Copy to Clipboard
                        </button>
                    </div>
                </div>

                <!-- Existing Keys -->
                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">üîë Active API Keys</h2>
                        <p class="md-card-subtitle" id="apiKeyCount">Loading...</p>
                    </div>

                    <div class="button-group" style="margin-bottom: 16px;">
                        <button onclick="loadAPIKeys()" class="md-button md-button-outlined">üîÑ Refresh</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Key Prefix</th>
                                    <th>User</th>
                                    <th>Scopes</th>
                                    <th>Created</th>
                                    <th>Last Used</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="apiKeysTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--md-on-surface-variant);">
                                        Loading API keys...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Usage Instructions -->
                <div class="md-card">
                    <div class="md-card-header">
                        <h2 class="md-card-title">üìñ Usage Instructions</h2>
                        <p class="md-card-subtitle">How to use API keys in your scripts</p>
                    </div>

                    <div style="background: var(--md-surface-3); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">HTTP Header Authentication:</div>
                        <code style="display: block; background: var(--md-surface-1); padding: 12px; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px;">
X-API-Key: yoss_your_api_key_here</code>
                    </div>

                    <div style="background: var(--md-surface-3); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">Example curl request:</div>
                        <code style="display: block; background: var(--md-surface-1); padding: 12px; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; white-space: pre-wrap;">curl -X POST https://yossarian.example.com/upload \
  -H "X-API-Key: yoss_xxx..." \
  -F "file=@logfile.log"</code>
                    </div>

                    <div style="margin-top: 16px;">
                        <a href="/docs" target="_blank" class="md-button md-button-outlined">
                            üìö View Full API Documentation
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // Navigation
        // ============================================
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const panelId = item.dataset.panel;
                if (!panelId) return;

                // Update nav
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');

                // Update panels
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById(panelId).classList.add('active');

                // Load data for specific panels
                if (panelId === 'system') loadSystemInfo();
                if (panelId === 'organization') loadOrgSettings();
                if (panelId === 'api-keys') loadAPIKeys();
            });
        });

        // ============================================
        // Utility Functions
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(type, message, elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = `status-message visible ${type}`;
                el.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span> ${message}`;
                setTimeout(() => el.classList.remove('visible'), 5000);
            }
        }

        // ============================================
        // Load Initial Data
        // ============================================
        function loadDynamicData() {
            loadHealthStatus();
            loadADStatus();
            loadADAccounts();
            loadSensitiveTerms();
            loadUserInfo();
            loadOrgSettings();
        }

        function loadHealthStatus() {
            fetch('/health')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('versionInfo').textContent = data.version || 'Unknown';
                    document.getElementById('healthStatus').className = 'health-indicator healthy';
                    document.getElementById('healthStatus').textContent = '‚óè Healthy';
                    
                    // Determine auth mode
                    const authStatus = document.getElementById('authStatus');
                    // We'll update this from userinfo
                })
                .catch(e => {
                    document.getElementById('healthStatus').className = 'health-indicator error';
                    document.getElementById('healthStatus').textContent = '‚óè Error';
                });
        }

        function loadUserInfo() {
            fetch('/api/userinfo')
                .then(r => r.json())
                .then(data => {
                    if (data.authenticated) {
                        document.getElementById('userName').textContent = data.username || 'Administrator';
                        document.getElementById('userAvatar').textContent = (data.username || 'A')[0].toUpperCase();
                        
                        // Update auth status indicator
                        const authStatus = document.getElementById('authStatus');
                        if (data.username === 'Administrator') {
                            authStatus.className = 'health-indicator warning';
                            authStatus.textContent = '‚óè Password';
                            document.getElementById('userRole').textContent = 'Local Admin';
                        } else {
                            authStatus.className = 'health-indicator healthy';
                            authStatus.textContent = '‚óè SSO Active';
                            document.getElementById('userRole').textContent = 'Enterprise SSO';
                        }
                    }
                })
                .catch(e => console.log('User info failed:', e));
        }

        function loadADStatus() {
            fetch('/admin/api/ldap/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('statUsers').textContent = data.user_count || 0;
                    document.getElementById('statComputers').textContent = data.computer_count || 0;
                    document.getElementById('accountCount').textContent = data.account_count || 0;
                    
                    const ldapStatus = document.getElementById('ldapStatus');
                    if (data.ldap_configured) {
                        ldapStatus.className = 'health-indicator healthy';
                        ldapStatus.textContent = '‚óè Connected';
                    } else {
                        ldapStatus.className = 'health-indicator warning';
                        ldapStatus.textContent = '‚óè Not Configured';
                    }
                })
                .catch(e => {
                    document.getElementById('ldapStatus').className = 'health-indicator error';
                    document.getElementById('ldapStatus').textContent = '‚óè Unavailable';
                });
        }

        function loadADAccounts() {
            const tbody = document.getElementById('adAccountsTable');
            
            fetch('/admin/api/accounts/list')
                .then(r => r.json())
                .then(data => {
                    tbody.innerHTML = '';
                    if (data.accounts && Object.keys(data.accounts).length > 0) {
                        Object.entries(data.accounts).slice(0, 100).forEach(([account, usn]) => {
                            const type = account.includes('$') ? 'Computer' : 
                                        account.includes('@') ? 'UPN' : 
                                        account.includes('\\') ? 'Domain' : 'Username';
                            const typeClass = type === 'Computer' ? 'info' : 'healthy';
                            
                            tbody.innerHTML += `
                                <tr>
                                    <td><code>${escapeHtml(account)}</code></td>
                                    <td><code>${escapeHtml(usn)}</code></td>
                                    <td><span class="health-indicator ${typeClass}">${type}</span></td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3" class="loading">No AD accounts found. Run LDAP sync to import accounts.</td></tr>';
                    }
                })
                .catch(e => {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">Failed to load AD accounts</td></tr>';
                });
        }

        function loadSensitiveTerms() {
            const tbody = document.getElementById('sensitiveTermsTable');
            
            fetch('/admin/api/sensitive/list')
                .then(r => r.json())
                .then(data => {
                    tbody.innerHTML = '';
                    document.getElementById('statSensitiveTerms').textContent = data.total || 0;
                    document.getElementById('termsCount').textContent = data.total || 0;
                    
                    if (data.terms && Object.keys(data.terms).length > 0) {
                        Object.entries(data.terms).forEach(([term, replacement]) => {
                            tbody.innerHTML += `
                                <tr>
                                    <td><code>${escapeHtml(term)}</code></td>
                                    <td><code>${escapeHtml(replacement)}</code></td>
                                    <td>
                                        <button class="md-button md-button-error md-button-sm" onclick="deleteSensitiveTerm('${escapeHtml(term)}')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3" class="loading">No sensitive terms configured</td></tr>';
                    }
                })
                .catch(e => {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">Failed to load sensitive terms</td></tr>';
                });
        }

        // ============================================
        // System Info
        // ============================================
        function loadSystemInfo() {
            // Load health for version info
            fetch('/health')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('sysVersion').textContent = data.version || 'Unknown';
                    document.getElementById('sysBuildTime').textContent = data.build_time || 'Unknown';
                    document.getElementById('sysGitCommit').textContent = data.commit || 'Unknown';
                })
                .catch(e => console.log('Health fetch failed'));

            // Load config limits
            fetch('/api/config')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('sysMaxTotal').textContent = (data.max_total_upload_size_mb || '-') + ' MB';
                    document.getElementById('sysMaxFile').textContent = (data.max_file_size_mb || '-') + ' MB';
                    document.getElementById('sysMaxCount').textContent = data.max_file_count || '-';
                })
                .catch(e => console.log('Config fetch failed'));

            // Load LDAP status
            fetch('/admin/api/ldap/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('sysLdapStatus').textContent = data.ldap_configured ? 'Configured' : 'Not Configured';
                    document.getElementById('sysLdapServer').textContent = data.ldap_server || 'N/A';
                    document.getElementById('sysLdapInterval').textContent = data.sync_interval ? (data.sync_interval + 's') : 'N/A';
                })
                .catch(e => console.log('LDAP status fetch failed'));

            // Determine auth mode from user info
            fetch('/api/userinfo')
                .then(r => r.json())
                .then(data => {
                    if (data.username === 'Administrator') {
                        document.getElementById('sysAuthMode').textContent = 'Password';
                        document.getElementById('sysOIDC').textContent = 'No';
                        document.getElementById('sysAutoSSO').textContent = 'N/A';
                    } else {
                        document.getElementById('sysAuthMode').textContent = 'Enterprise SSO';
                        document.getElementById('sysOIDC').textContent = 'Yes';
                        document.getElementById('sysAutoSSO').textContent = 'Yes';
                    }
                })
                .catch(e => console.log('Userinfo fetch failed'));

            // These would need backend endpoints to expose - showing placeholders
            document.getElementById('sysMinioEndpoint').textContent = 'minio:9000';
            document.getElementById('sysMinioBucket').textContent = 'yossarian-jobs';
            document.getElementById('sysMinioSSL').textContent = 'No';
            document.getElementById('sysADService').textContent = 'http://yossarian-db-service:8081';
            document.getElementById('sysRunMode').textContent = 'Frontend';
        }

        // ============================================
        // Actions
        // ============================================
        function syncAD() {
            showStatus('info', 'Starting AD synchronization...', 'dashboardStatus');
            showStatus('info', 'Starting AD synchronization...', 'adStatus');
            
            fetch('/admin/api/ldap/sync', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    const msg = `AD sync completed. ${data.accounts_imported || 0} accounts imported.`;
                    showStatus('success', msg, 'dashboardStatus');
                    showStatus('success', msg, 'adStatus');
                    loadADStatus();
                    loadADAccounts();
                })
                .catch(e => {
                    showStatus('error', 'AD sync failed: ' + e.message, 'dashboardStatus');
                    showStatus('error', 'AD sync failed: ' + e.message, 'adStatus');
                });
        }

        function testLDAP() {
            showStatus('info', 'Testing LDAP connection...', 'dashboardStatus');
            
            fetch('/admin/api/ldap/test')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showStatus('success', `LDAP test successful. Found ${data.users_found || 0} users.`, 'dashboardStatus');
                    } else {
                        showStatus('error', 'LDAP test failed: ' + data.message, 'dashboardStatus');
                    }
                })
                .catch(e => showStatus('error', 'LDAP test failed: ' + e.message, 'dashboardStatus'));
        }

        function refreshADAccounts() {
            loadADAccounts();
            showStatus('success', 'AD accounts refreshed', 'adStatus');
        }

        function exportMappings() {
            window.open('/mappings/csv', '_blank');
        }

        function exportADAccounts() {
            fetch('/admin/api/accounts/list')
                .then(r => r.json())
                .then(data => {
                    const csv = 'Account,USN\n' + 
                        Object.entries(data.accounts || {})
                            .map(([account, usn]) => `"${account}","${usn}"`)
                            .join('\n');
                    
                    downloadFile(csv, `ad-accounts-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                })
                .catch(e => showStatus('error', 'Export failed: ' + e.message, 'adStatus'));
        }

        // ============================================
        // Sensitive Terms
        // ============================================
        function addSensitiveTerm() {
            const term = document.getElementById('newTerm').value.trim();
            const replacement = document.getElementById('newReplacement').value.trim() || '[SENSITIVE]';
            
            if (!term) {
                showStatus('error', 'Term is required', 'termsStatus');
                return;
            }
            
            fetch('/admin/api/sensitive/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ term, replacement })
            })
            .then(r => r.json())
            .then(data => {
                showStatus('success', `Term "${term}" added successfully`, 'termsStatus');
                document.getElementById('newTerm').value = '';
                document.getElementById('newReplacement').value = '';
                loadSensitiveTerms();
            })
            .catch(e => showStatus('error', 'Failed to add term: ' + e.message, 'termsStatus'));
        }

        function deleteSensitiveTerm(term) {
            if (!confirm(`Delete sensitive term "${term}"?`)) return;
            
            fetch(`/admin/api/sensitive/delete?term=${encodeURIComponent(term)}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                showStatus('success', `Term "${term}" deleted`, 'termsStatus');
                loadSensitiveTerms();
            })
            .catch(e => showStatus('error', 'Failed to delete term: ' + e.message, 'termsStatus'));
        }

        function refreshSensitiveTerms() {
            loadSensitiveTerms();
            showStatus('success', 'Sensitive terms refreshed', 'termsStatus');
        }

        function exportSensitiveTerms() {
            fetch('/admin/api/sensitive/list')
                .then(r => r.json())
                .then(data => {
                    const csv = 'Term,Replacement\n' + 
                        Object.entries(data.terms || {})
                            .map(([term, replacement]) => `"${term}","${replacement}"`)
                            .join('\n');
                    
                    downloadFile(csv, `sensitive-terms-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                })
                .catch(e => showStatus('error', 'Export failed: ' + e.message, 'termsStatus'));
        }

        function importSensitiveTerms() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        let imported = 0;
                        let promises = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const matches = line.match(/^"([^"]*?)","([^"]*?)"$/) || line.split(',');
                            if (matches.length >= 2) {
                                const term = matches[1].replace(/"/g, '').trim();
                                const replacement = matches[2].replace(/"/g, '').trim() || '[SENSITIVE]';
                                
                                if (term) {
                                    promises.push(
                                        fetch('/admin/api/sensitive/add', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ term, replacement })
                                        }).then(() => imported++)
                                    );
                                }
                            }
                        }
                        
                        Promise.all(promises).then(() => {
                            showStatus('success', `Import completed: ${imported} terms added`, 'termsStatus');
                            loadSensitiveTerms();
                        });
                        
                    } catch (error) {
                        showStatus('error', 'Invalid CSV format', 'termsStatus');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ============================================
        // Organization Settings
        // ============================================
        function loadOrgSettings() {
            fetch('/admin/api/org-settings/list')
                .then(r => r.json())
                .then(data => {
                    const settings = data.settings || {};
                    
                    document.getElementById('disclaimerEnabled').checked = settings.disclaimer_enabled === 'true';
                    document.getElementById('disclaimerText').value = settings.disclaimer_text || '';
                    document.getElementById('docsEnabled').checked = settings.docs_enabled === 'true';
                    document.getElementById('docsTitle').value = settings.docs_title || 'Documentation';
                    document.getElementById('docsUrl').value = settings.docs_url || '';
                    
                    updateOrgPreview();
                })
                .catch(e => {
                    showStatus('error', 'Failed to load organization settings', 'orgStatus');
                });
        }

        function saveOrgSettings() {
            const settings = {
                disclaimer_enabled: document.getElementById('disclaimerEnabled').checked ? 'true' : 'false',
                disclaimer_text: document.getElementById('disclaimerText').value,
                docs_enabled: document.getElementById('docsEnabled').checked ? 'true' : 'false',
                docs_title: document.getElementById('docsTitle').value || 'Documentation',
                docs_url: document.getElementById('docsUrl').value
            };

            fetch('/admin/api/org-settings/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(r => r.json())
            .then(data => {
                showStatus('success', 'Organization settings saved successfully!', 'orgStatus');
                updateOrgPreview();
            })
            .catch(e => {
                showStatus('error', 'Failed to save settings: ' + e.message, 'orgStatus');
            });
        }

        function updateOrgPreview() {
            const disclaimerEnabled = document.getElementById('disclaimerEnabled').checked;
            const disclaimerText = document.getElementById('disclaimerText').value;
            const docsEnabled = document.getElementById('docsEnabled').checked;
            const docsTitle = document.getElementById('docsTitle').value || 'Documentation';
            const docsUrl = document.getElementById('docsUrl').value;

            let preview = '';

            if (disclaimerEnabled && disclaimerText) {
                preview += `
                    <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-left: 4px solid var(--md-warning); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 8px; color: #e65100;">‚ö†Ô∏è NOTICE</div>
                        <div style="font-size: 14px; color: #ef6c00;">${escapeHtml(disclaimerText)}</div>
                    </div>
                `;
            }

            if (docsEnabled && docsUrl) {
                preview += `
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-left: 4px solid var(--md-primary); padding: 16px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 500; margin-bottom: 4px;">üìö ${escapeHtml(docsTitle)}</div>
                                <div style="font-size: 13px; color: #1565c0;">${escapeHtml(docsUrl)}</div>
                            </div>
                            <div style="padding: 8px 16px; background: var(--md-primary); color: white; border-radius: 20px; font-size: 13px;">
                                View Documentation ‚Üí
                            </div>
                        </div>
                    </div>
                `;
            }

            if (!preview) {
                preview = '<p style="color: var(--md-on-surface-variant);">Enable settings above to see preview...</p>';
            }

            document.getElementById('orgPreview').innerHTML = preview;
        }

        // ============================================
        // Utilities
        // ============================================
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================
        // API Key Management
        // ============================================
        function loadAPIKeys() {
            fetch('/admin/api/api-keys/list/')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('apiKeysTableBody');
                    const keys = data.keys || [];
                    
                    document.getElementById('apiKeyCount').textContent = `${keys.length} key${keys.length !== 1 ? 's' : ''} configured`;
                    
                    if (keys.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: var(--md-on-surface-variant);">
                                    No API keys configured. Create one above to get started.
                                </td>
                            </tr>`;
                        return;
                    }
                    
                    tbody.innerHTML = keys.map(key => {
                        const createdDate = key.created_at ? new Date(key.created_at).toLocaleDateString() : 'Unknown';
                        const lastUsed = key.last_used_at ? new Date(key.last_used_at).toLocaleString() : 'Never';
                        const isExpired = key.expires_at && new Date(key.expires_at) < new Date();
                        const status = !key.is_active ? 'Revoked' : isExpired ? 'Expired' : 'Active';
                        const statusClass = !key.is_active ? 'error' : isExpired ? 'warning' : 'healthy';
                        
                        return `
                            <tr style="${!key.is_active || isExpired ? 'opacity: 0.6;' : ''}">
                                <td><strong>${escapeHtml(key.name)}</strong></td>
                                <td><code style="background: var(--md-surface-3); padding: 2px 6px; border-radius: 4px;">${escapeHtml(key.prefix)}...</code></td>
                                <td>${escapeHtml(key.username)}</td>
                                <td>${escapeHtml(key.scopes).split(',').map(s => 
                                    `<span style="background: var(--md-primary-container); color: var(--md-on-primary-container); padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px;">${s.trim()}</span>`
                                ).join('')}</td>
                                <td>${createdDate}</td>
                                <td>${lastUsed}</td>
                                <td><span class="health-indicator ${statusClass}">‚óè ${status}</span></td>
                                <td>
                                    ${key.is_active ? `
                                        <button onclick="revokeAPIKey(${key.id}, '${escapeHtml(key.name)}')" class="md-button md-button-warning" style="padding: 4px 12px; font-size: 12px;">
                                            Revoke
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteAPIKey(${key.id}, '${escapeHtml(key.name)}')" class="md-button md-button-error" style="padding: 4px 12px; font-size: 12px;">
                                        Delete
                                    </button>
                                </td>
                            </tr>`;
                    }).join('');
                })
                .catch(e => {
                    console.error('Failed to load API keys:', e);
                    document.getElementById('apiKeysTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--md-error);">
                                Failed to load API keys: ${e.message}
                            </td>
                        </tr>`;
                });
        }

        function createAPIKey() {
            const name = document.getElementById('apiKeyName').value.trim();
            if (!name) {
                showStatus('error', 'Please enter a name for the API key', 'apiKeysStatus');
                return;
            }

            const scopes = [];
            if (document.getElementById('scopeRead').checked) scopes.push('read');
            if (document.getElementById('scopeWrite').checked) scopes.push('write');
            if (document.getElementById('scopeAdmin').checked) scopes.push('admin');

            if (scopes.length === 0) {
                showStatus('error', 'Please select at least one scope', 'apiKeysStatus');
                return;
            }

            const expiresIn = parseInt(document.getElementById('apiKeyExpiry').value) || 0;

            showStatus('info', 'Creating API key...', 'apiKeysStatus');

            fetch('/admin/api/api-keys/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    scopes: scopes.join(','),
                    expires_in: expiresIn
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.key) {
                    // Show the key
                    document.getElementById('newKeyValue').textContent = data.key;
                    document.getElementById('newKeyDisplay').style.display = 'block';
                    
                    // Clear form
                    document.getElementById('apiKeyName').value = '';
                    document.getElementById('scopeRead').checked = true;
                    document.getElementById('scopeWrite').checked = true;
                    document.getElementById('scopeAdmin').checked = false;
                    document.getElementById('apiKeyExpiry').value = '0';
                    
                    showStatus('success', `API key "${name}" created successfully!`, 'apiKeysStatus');
                    loadAPIKeys();
                } else {
                    showStatus('error', 'Failed to create API key: ' + (data.error || 'Unknown error'), 'apiKeysStatus');
                }
            })
            .catch(e => {
                showStatus('error', 'Failed to create API key: ' + e.message, 'apiKeysStatus');
            });
        }

        function copyAPIKey() {
            const key = document.getElementById('newKeyValue').textContent;
            navigator.clipboard.writeText(key).then(() => {
                showStatus('success', 'API key copied to clipboard!', 'apiKeysStatus');
            }).catch(e => {
                showStatus('error', 'Failed to copy: ' + e.message, 'apiKeysStatus');
            });
        }

        function revokeAPIKey(id, name) {
            if (!confirm(`Revoke API key "${name}"?\n\nThis will immediately invalidate the key. This action cannot be undone.`)) {
                return;
            }

            fetch(`/admin/api/api-keys/revoke/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showStatus('success', `API key "${name}" has been revoked`, 'apiKeysStatus');
                    loadAPIKeys();
                })
                .catch(e => {
                    showStatus('error', 'Failed to revoke API key: ' + e.message, 'apiKeysStatus');
                });
        }

        function deleteAPIKey(id, name) {
            if (!confirm(`Delete API key "${name}"?\n\nThis will permanently remove the key from the system.`)) {
                return;
            }

            fetch(`/admin/api/api-keys/delete/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    showStatus('success', `API key "${name}" has been deleted`, 'apiKeysStatus');
                    loadAPIKeys();
                })
                .catch(e => {
                    showStatus('error', 'Failed to delete API key: ' + e.message, 'apiKeysStatus');
                });
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadDynamicData();
            
            // Live preview for org settings
            ['disclaimerEnabled', 'disclaimerText', 'docsEnabled', 'docsTitle', 'docsUrl'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateOrgPreview);
                    el.addEventListener('change', updateOrgPreview);
                }
            });
        });
    </script>
</body>
</html>
